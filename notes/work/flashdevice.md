<meta charset="utf-8">
<meta name="theme-color" content="#141518" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="icon" href="imaging.ico"/>
<link rel="icon" href="https://zdelv.github.io/public/notes/work/imaging.ico">
<style>
      body {
          position: relative;
          max-width: 1000px;
          margin-left: auto;
          margin-right: auto;
          padding-bottom: 500px;
          margin-top: 60px;
          font-size: 14px;
          font-family: Roboto, 'Bitstream Vera Sans', sans-serif;
          font-weight: 100;
          line-height: 150%;
          color: #9CAFB7;
          /*color: #1B6887;*/
      }

      html {
            background: #141518;
          > background: #000E14;
          \*background: #202020;*\
      }

      a:link, a:visited {
          color: rgb(221, 221, 221);
      }

      .md code {
          white-space: unset;
      }

      .md .longTOC a {
          font-family: Roboto;
      }

      .md a {
          font-family: Roboto;
      }

      a:hover {
          color: #FFF;
      }

      h1 {
          margin-top: 40px;
          padding-bottom: 2px;
          border-bottom: 2px solid;
          font-size: 18px;
          color: #fff;
      }

      .md h2 {
          font-size: 17px;
          margin-top: 25px;
          color: #fff;
      }

      .md .nonumberh3 {
          font-family: Roboto;
          font-size: 15px;
          margin-top: 20px;
          margin-bottom: -3px;
          color: #fff;
      }

      .md h3 {
          font-size: 15px;
          margin-top: 20px;
          margin-bottom: -3px;
          color: #fff;
      }
 
      div.view {
         position: absolute;
         width: 268px;
         text-align:center;
      }

      div.window {
         font-family: Tahoma, Arial, sans-serif; 
         text-align:left;
         background: #EEE;
         border: 1px solid #44A;
         color: #000;
         font-size: 11px;
         padding-left: 0px;
         padding-right: 1px;
         padding-bottom: 0px;
         padding-top: 20px;
         position: relative;
         -webkit-box-shadow: 0px 4px 18px 0px rgba(0,0,0,0.42);
         -moz-box-shadow: 0px 4px 18px 0px rgba(0,0,0,0.42);
         box-shadow: 0px 4px 18px 0px rgba(0,0,0,0.42);      
      }

      div.window iframe {
         width: 355px;
         height: 450px;
         background: #FFF;
         border: none;
         margin-bottom: -120px;
         transform-origin: 0 0;
         -ms-transform-origin: 0 0;
         -webkit-transform-origin: 0 0;
         transform: scale(0.75,0.75);
      }

      div.window div.icon {
         position: absolute; 
         top: 1px; 
         padding-left: 3px;
         font-size: 14px;
      }

      div.window div.caption, div.window div.tab {
         position: absolute; 
         top: 2px; 
         width: 100%; 
         text-align: center;
         padding-bottom: 4px; 
         color: #444;
      }

      div.window div.tab {
         text-align: left;
         padding-left: 30px;
      }

      div.window div.menu {
         background: #DDD;
         border-top: 1px solid #555;
         width: 100%;
      }

      div.window div.buttons {
         position: absolute;
         right: 4px;
         top: 0px;
         font-size: 18px;
      }

      code {
         font-size: 11.5px; 
         font-family: Monaco, monospace;
         color: #fff;
      }

      .md pre.tilde {
         background: #25272a;
         border-top: 1px solid #343434;
         border-left: 1px solid #343434;
         border-right: 1px solid #343434;
         border-bottom: 1px solid #343434;
      }

      :not(.code) > code {
        margin-left: -2px;
        margin-right: -2px;
        padding-left: 3px;
        padding-right:3px;
        /*background: rgba(255,255,255,0.1);*/
      }
 
      .code {
         border: 2px solid; 
         background: #678; 
         padding: 10px; 
         margin-bottom: 15px; 
         margin-top: 15px;
      }

      dt {
         font-weight: bold;
      }

      dd {
         margin-top: 5px;
         margin-bottom: 15px;
      }

      .title {
        font-weight: bold;
        font-size: 30px;
        padding-bottom: 3px;
        padding-right: 8px;
        color:#fff;
      }

      /*.line {
         margin-left: 34px;
         margin-top: -5px;
         width: 180px;
         height: 1px;
         display: inline-block;
         background: #fff;
      }*/

      .md svg.diagram {
          stroke: #fff;
          fill: #fff;
          font-size: 13px;
          font-family: Roboto Mono, IBM Plex Mono, Anonymous Pro;
      }
      
      @import url('https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:300');
</style>
<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|Roboto|Roboto+Mono" rel="stylesheet">

**Flash Device Documentation**

Overview
========================= 

This documentation describes the use of the flashdevice script.

Installing script
-----------------

The script can be found at https://github.com/zdelv/macos-scripts.


To remotely download the script on a device, it is recommended that you use the following bash command:

~~~~~~~~~~~~~~~~~ bash
curl https://raw.githubusercontent.com/zdelv/macos-scripts/master/flashdevice -o flashdevice && chmod +x flashdevice
~~~~~~~~~~~~~~~~~


Running the script
------------------

~~~~~~~~~~~~~~~~~ text
flashdevice.sh -d PATH --dev PATH [OPTIONS]

Drive flashing utility. Given the path to a DMG and dev path to a drive, flash the drive using ASR.

 Required:
  -d, --dmg         Path to DMG
  --dev, --drive    Path to drive for imaging (/dev/disk2 etc)

 Options:
  -h, --help        Display this help and exit
  -v, --verbose     Enable verbose output
  --noverify        Do not verify before restoring (just run the script)
~~~~~~~~~~~~~~~~~

The script is a terminal only application. It requires the path to the DMG and the drive to be erased.


+ The -d or --dmg flags passes the path to the DMG.
    + The DMG must be restore-able, using the AutoDMG process described in the [Imaging Notes documentation](http://zdelvecch.io/notes/work/imagingnotes.html#misc/quickimaging/autodmgsetup).
    + Must be the exact path to the DMG.
+ The --dev or --drive flags passes the path to the drive that will be imaged onto.
    + This must be a block path (/dev/disk2, /dev/disk3, etc).
        + You can find these by using diskutil list in terminal and finding your drive (based on size and volume names).
    + The drive will be formatted so please be careful when finding this drive.
+ The --noverify flag will skip the verification on the paths before erasing and restoring the drive.
+ The -v or --verbose flags will enable verbose output on the ASR command.

!!! ERROR APFS ONLY!
    The script is currently only setup to format the drives to an APFS partition. There is no support for formatting to HFS+.
    
    Because of this, it is very important to make sure the host computer has the updated firmware which can only be installed by going from < 10.13 to > 10.13 by using the regular macOS installer. You can check your firmware version by following the instructions on [Apple's website](https://support.apple.com/en-us/HT201518).

The setup process will warn you along the way if it detects that you accidentally selected an external disk or if you did not supply a correct path.


Sample Usage
------------

~~~~~~~~~~~~~~ text
techs-MacBook-Air:~ root# flashdevice -d /private/var/amh/DMGs/HighSierra-10-13-6.dmg --dev /dev/disk2

The drive selected is not an internal drive!
Are you sure you would like to continue? [y/n]: y


---------------------------------------------
The following will occur:
Drive /dev/disk2 will be erased.
DMG located at /private/var/amh/DMGs/HighSierra-10-13-6.dmg will be restored.
Are you sure this is correct? [y/n]: y
---------------------------------------------

Continuing . . . 

---------------------------------------------
Erasing drive /dev/disk2 . . . 
Started erase on disk2
Unmounting disk
Creating the partition map
Waiting for partitions to activate
Formatting disk2s2 as APFS with name Macintosh HD
Mounting disk
Finished erase on disk2
Sucessfully erased disk!
---------------------------------------------

---------------------------------------------
Restoring DMG /private/var/amh/DMGs/HighSierra-10-13-6.dmg onto empty drive . . . 
	Validating target...done
	Validating source...done
	Retrieving scan information...done
	Replicating ....10....20....30....40....50....60....70....80....90....100
	Restored target device is /dev/disk5s1.

Sucessfully restored disk!
---------------------------------------------

Finished!
~~~~~~~~~~~~~~


<!-- Markdeep: --><style class="fallback">body{visibility:hidden;white-space:pre;font-family:monospace}</style><script src="markdeep.min.js"></script><script src="https://casual-effects.com/markdeep/latest/markdeep.min.js?" type="text/javascript"></script><script>window.alreadyProcessedMarkdeep||(document.body.style.visibility="visible")</script>
